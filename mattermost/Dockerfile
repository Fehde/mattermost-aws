FROM    ubuntu:22.10

ARG PUID=2000
ARG PGID=2000
ARG MATTERMOST_IMAGE_TAG
ARG MM_SQLSETTINGS_DRIVERNAME
ARG MM_SQLSETTINGS_DATASOURCE
ARG MM_SERVICESETTINGS_SITEURL
ARG MM_SERVICESETTINGS_ENABLEAPICHANNELDELETION
ARG MM_SERVICESETTINGS_ENABLETUTORIAL
ARG MM_LOCALIZATIONSETTINGS_DEFAULTSERVERLOCALE
ARG MM_LOCALIZATIONSETTINGS_DEFAULTCLIENTLOCALE
ARG MM_TEAMSETTINGS_MAXCHANNELSPERTEAM
ARG MM_PLUGINSETTINGS_ENABLE
ARG MM_PLUGINSETTINGS_ENABLEUPLOADS
ENV MM_SQLSETTINGS_DRIVERNAME=${MM_SQLSETTINGS_DRIVERNAME}
ENV MM_SQLSETTINGS_DATASOURCE=${MM_SQLSETTINGS_DATASOURCE}
ENV MM_SERVICESETTINGS_SITEURL=${MM_SERVICESETTINGS_SITEURL}
ENV MM_SERVICESETTINGS_ENABLEAPICHANNELDELETION=${MM_SERVICESETTINGS_ENABLEAPICHANNELDELETION}
ENV MM_SERVICESETTINGS_ENABLETUTORIAL=${MM_SERVICESETTINGS_ENABLETUTORIAL}
ENV MM_LOCALIZATIONSETTINGS_DEFAULTSERVERLOCALE=${MM_LOCALIZATIONSETTINGS_DEFAULTSERVERLOCALE}
ENV MM_LOCALIZATIONSETTINGS_DEFAULTCLIENTLOCALE=${MM_LOCALIZATIONSETTINGS_DEFAULTCLIENTLOCALE}
ENV MM_TEAMSETTINGS_MAXCHANNELSPERTEAM=${MM_TEAMSETTINGS_MAXCHANNELSPERTEAM}
ENV MM_PLUGINSETTINGS_ENABLE=${MM_PLUGINSETTINGS_ENABLE}
ENV MM_PLUGINSETTINGS_ENABLEUPLOADS=${MM_PLUGINSETTINGS_ENABLEUPLOADS}

RUN apt update && apt -y upgrade && apt install -y jq vim ca-certificates

ADD https://releases.mattermost.com/${MATTERMOST_IMAGE_TAG}/mattermost-${MATTERMOST_IMAGE_TAG}-linux-amd64.tar.gz .
RUN tar -zxvf mattermost-*-linux-amd64.tar.gz \
    && rm -f mattermost-*-linux-amd64.tar.gz

RUN mv -f mattermost /opt \
    && mkdir -p /opt/mattermost/config /opt/mattermost/data /opt/mattermost/logs /opt/mattermost/plugins /opt/mattermost/client/plugins /opt/mattermost/bleve-indexes

ENV PATH $PATH:/opt/mattermost/bin

RUN groupadd --system --gid=${PGID} mattermost \
    && useradd --system -m --uid ${PUID} --gid mattermost mattermost \
    && chown -R mattermost:mattermost /opt/mattermost \
    && chmod -R g+w /opt/mattermost

# RUN mkdir /home/mattermost \
#     && chown -R mattermost:mattermost /home/mattermost \
#     && chmod -R g+w /home/mattermost

CMD ["/opt/mattermost/bin/mattermost"]
